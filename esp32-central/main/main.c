#include <stdio.h>
#include <string.h>
#include "driver/i2c.h"
#include "esp_log.h"

#define OLED_ADDR 0x3C

// Piny I2C
#define I2C_MASTER_SCL_IO 41
#define I2C_MASTER_SDA_IO 35
#define I2C_MASTER_NUM I2C_NUM_0
#define I2C_MASTER_FREQ_HZ 400000
#define I2C_MASTER_TX_BUF_DISABLE 0
#define I2C_MASTER_RX_BUF_DISABLE 0

#define TAG "SH1106"

// RAM ekranu (128x64 = 1024 bajtów)
static uint8_t oled_buffer[128 * 8] = {0};

esp_err_t oled_init();
esp_err_t oled_send_command(uint8_t cmd);
esp_err_t oled_update_display();
void oled_draw_pixel(int x, int y);
void oled_draw_char(int x, int y, char c);
void oled_draw_text(int x, int y, const char *text);

// Minimalny font 5x7 zawierający znaki potrzebne do "Hello, World!"
// Możesz znaleźć pełne fonty 5x7 w internecie.
// Kolejność: znak - kod ASCII - 5 kolumn, każdy bit w kolumnie to piksel (LSB = góra)
static const uint8_t font5x7_full[96][5] = {
  {0x00,0x00,0x00,0x00,0x00}, // ' ' 32
  {0x00,0x00,0x5F,0x00,0x00}, // '!' 33
  {0x00,0x03,0x00,0x03,0x00}, // '"' 34
  {0x14,0x7F,0x14,0x7F,0x14}, // '#' 35
  {0x24,0x2A,0x7F,0x2A,0x12}, // '$' 36
  {0x23,0x13,0x08,0x64,0x62}, // '%' 37
  {0x36,0x49,0x55,0x22,0x50}, // '&' 38
  {0x00,0x05,0x03,0x00,0x00}, // ''' 39
  {0x00,0x1C,0x22,0x41,0x00}, // '(' 40
  {0x00,0x41,0x22,0x1C,0x00}, // ')' 41
  {0x14,0x08,0x3E,0x08,0x14}, // '*' 42
  {0x08,0x08,0x3E,0x08,0x08}, // '+' 43
  {0x00,0x50,0x30,0x00,0x00}, // ',' 44
  {0x08,0x08,0x08,0x08,0x08}, // '-' 45
  {0x00,0x60,0x60,0x00,0x00}, // '.' 46
  {0x20,0x10,0x08,0x04,0x02}, // '/' 47
  {0x3E,0x51,0x49,0x45,0x3E}, // '0' 48
  {0x00,0x42,0x7F,0x40,0x00}, // '1' 49
  {0x42,0x61,0x51,0x49,0x46}, // '2' 50
  {0x21,0x41,0x45,0x4B,0x31}, // '3' 51
  {0x18,0x14,0x12,0x7F,0x10}, // '4' 52
  {0x27,0x45,0x45,0x45,0x39}, // '5' 53
  {0x3C,0x4A,0x49,0x49,0x30}, // '6' 54
  {0x01,0x71,0x09,0x05,0x03}, // '7' 55
  {0x36,0x49,0x49,0x49,0x36}, // '8' 56
  {0x06,0x49,0x49,0x29,0x1E}, // '9' 57
  {0x00,0x36,0x36,0x00,0x00}, // ':' 58
  {0x00,0x56,0x36,0x00,0x00}, // ';' 59
  {0x08,0x14,0x22,0x41,0x00}, // '<' 60
  {0x14,0x14,0x14,0x14,0x14}, // '=' 61
  {0x00,0x41,0x22,0x14,0x08}, // '>' 62
  {0x02,0x01,0x51,0x09,0x06}, // '?' 63
  {0x32,0x49,0x79,0x41,0x3E}, // '@' 64
  {0x7E,0x11,0x11,0x11,0x7E}, // 'A' 65
  {0x7F,0x49,0x49,0x49,0x36}, // 'B' 66
  {0x3E,0x41,0x41,0x41,0x22}, // 'C' 67
  {0x7F,0x41,0x41,0x22,0x1C}, // 'D' 68
  {0x7F,0x49,0x49,0x49,0x41}, // 'E' 69
  {0x7F,0x09,0x09,0x09,0x01}, // 'F' 70
  {0x3E,0x41,0x49,0x49,0x7A}, // 'G' 71
  {0x7F,0x08,0x08,0x08,0x7F}, // 'H' 72
  {0x00,0x41,0x7F,0x41,0x00}, // 'I' 73
  {0x20,0x40,0x41,0x3F,0x01}, // 'J' 74
  {0x7F,0x08,0x14,0x22,0x41}, // 'K' 75
  {0x7F,0x40,0x40,0x40,0x40}, // 'L' 76
  {0x7F,0x02,0x04,0x02,0x7F}, // 'M' 77
  {0x7F,0x02,0x04,0x08,0x7F}, // 'N' 78
  {0x3E,0x41,0x41,0x41,0x3E}, // 'O' 79
  {0x7F,0x09,0x09,0x09,0x06}, // 'P' 80
  {0x3E,0x41,0x51,0x21,0x5E}, // 'Q' 81
  {0x7F,0x09,0x19,0x29,0x46}, // 'R' 82
  {0x46,0x49,0x49,0x49,0x31}, // 'S' 83
  {0x01,0x01,0x7F,0x01,0x01}, // 'T' 84
  {0x3F,0x40,0x40,0x40,0x3F}, // 'U' 85
  {0x1F,0x20,0x40,0x20,0x1F}, // 'V' 86
  {0x7F,0x20,0x10,0x20,0x7F}, // 'W' 87
  {0x63,0x14,0x08,0x14,0x63}, // 'X' 88
  {0x07,0x08,0x70,0x08,0x07}, // 'Y' 89
  {0x61,0x51,0x49,0x45,0x43}, // 'Z' 90
  {0x00,0x7F,0x41,0x41,0x00}, // '[' 91
  {0x02,0x04,0x08,0x10,0x20}, // '\' 92
  {0x00,0x41,0x41,0x7F,0x00}, // ']' 93
  {0x04,0x02,0x01,0x02,0x04}, // '^' 94
  {0x80,0x80,0x80,0x80,0x80}, // '_' 95
  {0x00,0x01,0x02,0x00,0x00}, // '`' 96
  {0x20,0x54,0x54,0x54,0x78}, // 'a' 97
  {0x7F,0x48,0x44,0x44,0x38}, // 'b' 98
  {0x38,0x44,0x44,0x44,0x20}, // 'c' 99
  {0x38,0x44,0x44,0x48,0x7F}, // 'd' 100
  {0x38,0x54,0x54,0x54,0x18}, // 'e' 101
  {0x08,0x7E,0x09,0x01,0x02}, // 'f' 102
  {0x08,0x54,0x54,0x54,0x3C}, // 'g' 103
  {0x7F,0x08,0x04,0x04,0x78}, // 'h' 104
  {0x00,0x44,0x7D,0x40,0x00}, // 'i' 105
  {0x20,0x40,0x44,0x3D,0x00}, // 'j' 106
  {0x7F,0x10,0x28,0x44,0x00}, // 'k' 107
  {0x00,0x41,0x7F,0x40,0x00}, // 'l' 108
  {0x7C,0x04,0x18,0x04,0x78}, // 'm' 109
  {0x7C,0x08,0x04,0x04,0x78}, // 'n' 110
  {0x38,0x44,0x44,0x44,0x38}, // 'o' 111
  {0x7C,0x14,0x14,0x14,0x08}, // 'p' 112
  {0x08,0x14,0x14,0x14,0x7C}, // 'q' 113
  {0x7C,0x08,0x04,0x04,0x08}, // 'r' 114
  {0x48,0x54,0x54,0x54,0x20}, // 's' 115
  {0x04,0x3F,0x44,0x40,0x20}, // 't' 116
  {0x3C,0x40,0x40,0x20,0x7C}, // 'u' 117
  {0x1C,0x20,0x40,0x20,0x1C}, // 'v' 118
  {0x3C,0x40,0x30,0x40,0x3C}, // 'w' 119
  {0x44,0x28,0x10,0x28,0x44}, // 'x' 120
  {0x0C,0x50,0x50,0x50,0x3C}, // 'y' 121
  {0x44,0x64,0x54,0x4C,0x44}, // 'z' 122
  {0x00,0x08,0x36,0x41,0x00}, // '{' 123
  {0x00,0x00,0x7F,0x00,0x00}, // '|' 124
  {0x00,0x41,0x36,0x08,0x00}, // '}' 125
  {0x02,0x01,0x02,0x04,0x02}, // '~' 126
};



// Wysyłanie komendy do OLED
esp_err_t oled_send_command(uint8_t cmd) {
    uint8_t data[2] = {0x00, cmd};
    return i2c_master_write_to_device(I2C_MASTER_NUM, OLED_ADDR, data, 2, pdMS_TO_TICKS(100));
}

// Inicjalizacja OLED
esp_err_t oled_init() {
    uint8_t init_cmds[] = {
        0xAE,       // Display Off
        0xD5, 0x80, // Clock divide ratio
        0xA8, 0x3F, // Multiplex ratio (64)
        0xD3, 0x00, // Display offset
        0x40,       // Start line at 0
        0xA1,       // Segment remap (flip horizontally)
        0xC8,       // COM output scan direction (flip vertically)
        0xDA, 0x12, // COM pins hardware config
        0x81, 0x7F, // Contrast control
        0xA4,       // Resume to RAM content
        0xA6,       // Normal display
        0xD9, 0xF1, // Precharge period
        0xDB, 0x40, // VCOMH deselect level
        0xAF        // Display ON
    };
    for (size_t i = 0; i < sizeof(init_cmds); i++) {
        if (oled_send_command(init_cmds[i]) != ESP_OK) {
            return ESP_FAIL;
        }
    }
    return ESP_OK;
}

// Aktualizacja wyświetlacza
esp_err_t oled_update_display() {
    for (uint8_t page = 0; page < 8; page++) {
        // Ustawianie strony i kolumn z offsetem charakterystycznym dla SH1106
        ESP_ERROR_CHECK(oled_send_command(0xB0 + page));
        ESP_ERROR_CHECK(oled_send_command(0x02)); // Lower column start (offset)
        ESP_ERROR_CHECK(oled_send_command(0x10)); // Higher column start

        uint8_t buffer[129];
        buffer[0] = 0x40; // Bajt kontrolny do danych
        memcpy(&buffer[1], &oled_buffer[page * 128], 128);
        ESP_ERROR_CHECK(i2c_master_write_to_device(I2C_MASTER_NUM, OLED_ADDR, buffer, sizeof(buffer), pdMS_TO_TICKS(100)));
    }
    return ESP_OK;
}

void oled_draw_pixel(int x, int y) {
    if (x < 0 || x >= 128 || y < 0 || y >= 64) return;
    oled_buffer[x + (y / 8) * 128] |= (1 << (y % 8));
}

// Rysowanie znaku 5x7
void oled_draw_char(int x, int y, char c) {
    if (c < 32 || c > 127) return;
    for (int i = 0; i < 5; i++) {
        uint8_t line = font5x7_full[c - 32][i];
        for (int j = 0; j < 8; j++) {
            if (line & (1 << j)) {
                oled_draw_pixel(x + i, y + j);
            }
        }
    }
}

// Rysowanie tekstu
void oled_draw_text(int x, int y, const char *text) {
    while (*text) {
        oled_draw_char(x, y, *text);
        x += 6;
        text++;
        if (x + 6 >= 128) break;
    }
}

void app_main(void) {
    // Inicjalizacja I2C
    i2c_config_t conf = {
        .mode = I2C_MODE_MASTER,
        .sda_io_num = I2C_MASTER_SDA_IO,
        .scl_io_num = I2C_MASTER_SCL_IO,
        .sda_pullup_en = GPIO_PULLUP_ENABLE,
        .scl_pullup_en = GPIO_PULLUP_ENABLE,
        .master.clk_speed = I2C_MASTER_FREQ_HZ,
    };
    ESP_ERROR_CHECK(i2c_param_config(I2C_MASTER_NUM, &conf));
    ESP_ERROR_CHECK(i2c_driver_install(I2C_MASTER_NUM, conf.mode, I2C_MASTER_RX_BUF_DISABLE, I2C_MASTER_TX_BUF_DISABLE, 0));

    ESP_LOGI(TAG, "I2C zainicjalizowane.");

    // Inicjalizacja OLED
    ESP_ERROR_CHECK(oled_init());

    // Rysowanie "Hello, World!"
    oled_draw_text(0, 0, "Hello,");
    oled_draw_text(0, 8, "World!");
    oled_update_display();
    ESP_LOGI(TAG, "Tekst wyświetlony.");

    while (1) {
        vTaskDelay(pdMS_TO_TICKS(1000));
    }
}
